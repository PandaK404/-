# **SCALAR: Self-Calibrated Acoustic** Ranging for Distributed Mobile Devices

使用分布式设备实现距离测量

[TOC]

## 摘要

本文介绍了一种在分布式异步移动设备上实现==亚毫米级精度==的自校准声学测距系统。基于我们的理论定时模型，我们可以用仔细设计的OFDM测距信号精确地==抵消系统延迟和非线性时钟漂移==。在实际实验中，我们的系统在三米范围内达到了==0.54毫米==的测距精度。更重要的是，我们的一次测量方案在0.5秒内返回正确的冷启动距离，无需用户干预。利用我们的系统提供的新能力，我们可以通过测量声速的微小变化以==0.25摄氏度==的精度监测环境温度。



## 时间误差来源

+ 系统启动延迟

  在播放音频时，应用程序将数字音频放入播放缓冲区的时间与扬声器实际播放音频样本的时间之间存在系统延迟。同样，从麦克风录制音频时也存在系统延迟。

  一旦播放/录制开始，系统延迟是固定的，不对影响后续的信号采集。

  如何观察：静止物体放置在前面，距离测量不准确，并且每次都不一样。

+ 收发设备的始终漂移

  移动设备上的音频系统使用本地振荡器生成采样时钟。由于硬件缺陷和温度变化，本地振荡器产生的频率误差可能高达±50 ppm（百万分之一）。在采样频率为48 kHz时，这种误差导致两个设备之间的最大频率差为2.4 Hz。

  在不同的采样时钟下，不同设备采集的数字样本不对齐，并且由于累积的时钟差异，两个数字序列之间的采样偏移量不断变化。

  如何观察：静止物体放置在前面，如果相位一直稳定线性漂移，那么就是有时钟漂移。

## 已有的解决思路

+ 矫正：一般认为时钟漂移是一个稳定量，实验发现这个量在短时间和长时间上并不一样，粗略估计可以认为是一个稳定量。

## 本文方法

传统的时钟偏移模型：设备A的时间为 $t_A$，设备B的时间为$t_B$。则$t_B=t_A-pt-b$。b可以当作是初始的启动延迟带来的时钟偏移，p是由于时钟漂移带来的时钟偏移。

上述方法中认为p和b是固定的，但是实际上p是波动变化的一个量。会随着温度的变化而变化。

![image-20210922103518677](https://tva1.sinaimg.cn/large/008i3skNgy1gup7buaco1j61a60h0wic02.jpg)

### 时间模型

$t_A=t-q_A(t)$，t是标准时间，$q_A(t)$是A的时钟偏移方程，认为是一个非线形的方程。

上述模型的假设：

系统延迟和时钟漂移在短时间内是准静态的。eg：40ms，距离足够远可以传播13.6米，并且该时间内引起的偏移经过计算小于1mm。

根据假设，设备A在一次信号的发生期间（例如开始发送时间为$t_0$）是一个稳定的量。

![image-20210922110206573](https://tva1.sinaimg.cn/large/008i3skNgy1gup83qfmg0j60yo0g240m02.jpg)

上图是信号发送/接收过程的建模图。

假设设备A的本地时间为0，则在$t=t_A+q_A(t_0)=q_A(t_0)$时刻，设备A接收到发送信号的命令开始准备发信号，经过一个时间延迟$\tau'_{AS}$后，信号从缓存区真正发出，因此设备A发出信号的时间为$t=q_A(t_0)+\tau'_{AS}$。经过一个距离$d_{AB}$后，信号达到了接收设备B，在一个系统延迟$\tau'_{BR}$后信号达到了接收的缓存区被接收。

B收到信号的标准时间为$t=q_A(t_0)+\tau'_{AS}+d_{AB}/c+\tau'_{BR}$，同时有$t_B=t-q_B(t_0)$。

因此有，
$$
t_B+q_B(t_0)=q_A(t_0)+\tau'_{AS}+d_{AB}/c+\tau'_{BR}
$$

$$
\tau_{AB}=q_A(t_0)+\tau'_{AS}+d_{AB}/c+\tau'_{BR}-q_B(t_0)
$$

基于假设，$q_A(t_0)$和$\tau'_{AS}$在短时间内可以看作是常量，定义发送端延迟为$\tau_{AS}=q_A(t_0)+\tau'_{AS}$，接收端延迟为$\tau_{BR}=\tau'_{BR}-q_B(t_0)$，因此公式2可以简化为
$$
\tau_{AB}=\tau_{AS}+d_{AB}/c+\tau_{BR}
$$
![image-20210922113317829](https://tva1.sinaimg.cn/large/008i3skNgy1gup906hzjjj60ws0ai3zm02.jpg)

如果有两个设备可以同时收发信号，例如上图所示，那么我们可以计算4个延迟，$\tau_{AA}$，$\tau_{AB}$，$\tau_{BA}$，$\tau_{BB}$。

对于可以同时发射和接收的两个设备，我们可以使用四个延迟测量值计算两个设备之间的距离，如下所示：
$$
d_{AB}+d_{BA}=d_{AA}+d_{BB}-c(\tau_{AA}+\tau_{BB}-\tau_{AB}-\tau_{BA})
$$
因此:
$$
d_{AB}=\frac{d_{AA}+d_{BB}-c(\tau_{AA}+\tau_{BB}-\tau_{AB}-\tau_{BA})}{2}
$$
作者认为$d_{AA}$和$d_{BB}$是一个定值，可以预先测量得到。后续设计OFDM信号来进行距离计算。

## 在 小米音响/没有多个设备时 如何使用？

我的问题：

1）麦克风接受信号也有启动延迟，如何保证信号发出并且到达麦克风时麦克风已经启动？

2）按照上述时间模型，多麦克风阵列如何利用？









## 其他

小米音响的麦克风没问题。

试试speaker是不是不行。





